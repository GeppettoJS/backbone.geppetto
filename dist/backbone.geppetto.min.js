!function(a){"function"==typeof define&&define.amd?define(["underscore","backbone"],a):a(_,Backbone)}(function(a,b){"use strict";if(!b)throw"Please include Backbone before Geppetto";var c="no mapping found for key: ",d=function(a){this._mappings={},this._context=a,this.parent=void 0};d.prototype={_createAndSetupInstance:function(a,b){var c=new b;return this.injectInto(c,a),c},_retrieveFromCacheOrCreate:function(a,b){var d;if(this._mappings.hasOwnProperty(a)){var e=this._mappings[a];!b&&e.isSingleton?(e.object||(e.object=this._createAndSetupInstance(a,e.clazz)),d=e.object):e.isView?d=this._wrapViewConstructor(e.clazz):e.clazz&&(d=this._createAndSetupInstance(a,e.clazz))}else{if(!this.parent||!this.parent.hasMapping(a))throw new Error(c+a);d=this.parent._retrieveFromCacheOrCreate(a,b)}return d},_wrapViewConstructor:function(a){var b=this._context,c=a.extend({initialize:function(){b.injector.injectInto(this),a.prototype.initialize.call(this,arguments)}});return c},createChildInjector:function(){var a=new d(this._context);return a.parent=this,a},getObject:function(a){return this._retrieveFromCacheOrCreate(a,!1)},mapValue:function(a,b){return this._mappings[a]={clazz:null,object:b,isSingleton:!0},this},hasMapping:function(a){return this._mappings.hasOwnProperty(a)||!!this.parent&&this.parent.hasMapping(a)},mapClass:function(a,b){return this._mappings[a]={clazz:b,object:null,isSingleton:!1},this},mapView:function(a,b){return this._mappings[a]={clazz:b,object:null,isSingleton:!1,isView:!0},this},mapSingleton:function(a,b){return this._mappings[a]={clazz:b,object:null,isSingleton:!0},this},instantiate:function(a){return this._retrieveFromCacheOrCreate(a,!0)},injectInto:function(b){return"object"==typeof b&&"injections"in b&&a.each(b.injections,function(a){b[a]=this.getObject(a)},this),this.addPubSub(b),this},addPubSub:function(b){b.listen=a.bind(this._context.listen,this._context),b.dispatch=a.bind(this._context.dispatch,this._context)},unmap:function(a){return delete this._mappings[a],this},unmapAll:function(){return this._mappings={},this}};var e={};e.version="0.6.3",e.EVENT_CONTEXT_SHUTDOWN="Geppetto:contextShutdown",e.Injector=d;var f={};e.Context=function(c){this.options=c||{},this.parentContext=this.options.parentContext,this.injector=this.parentContext?this.parentContext.injector.createChildInjector():new d(this),this.vent={},a.extend(this.vent,b.Events),a.isFunction(this.initialize)&&this.initialize.apply(this,arguments),this._contextId=a.uniqueId("Context"),f[this._contextId]=this,this.mapCommands()},e.bindContext=function(b){this.options=b||{};var c=this.options.view,d=null;return"function"==typeof this.options.context?(d=new this.options.context(this.options),c.close||(c.close=function(){c.trigger("close"),c.remove()}),c.on("close",function(){c.off("close"),d.unmapAll()})):"object"==typeof this.options.context&&(d=this.options.context),c.context=d,d.injector.injectInto(c),a.each(c.contextEvents,function(b,e){a.isFunction(b)?d.listen(c,e,b):a.isString(b)&&d.listen(c,e,c[b])}),d},e.Context.prototype.listen=function(b,c,d){if(3!==arguments.length)throw"Expected 3 arguments (target, eventName, callback)";if(!a.isObject(b)||!a.isFunction(b.listenTo)||!a.isFunction(b.stopListening))throw"Target for listen() must define a 'listenTo' and 'stopListening' function";if(!a.isString(c))throw"eventName must be a String";if(!a.isFunction(d))throw"callback must be a function";return b.listenTo(this.vent,c,d,b)},e.Context.prototype.dispatch=function(b,c){if(!a.isUndefined(c)&&!a.isObject(c))throw"Event payload must be an object";c=c||{},c.eventName=b,this.vent.trigger(b,c)},e.Context.prototype.dispatchToParent=function(a,b){this.parentContext&&this.parentContext.vent.trigger(a,b)},e.Context.prototype.dispatchGlobally=function(b,c){a.each(f,function(a){a.vent.trigger(b,c)})},e.Context.prototype.mapCommand=function(b,c){var d=this;if(!a.isFunction(c))throw"Command must be constructable";this.vent.listenTo(this.vent,b,function(e){var f=new c;f.context=d,f.eventName=b,f.eventData=e,d.injector.injectInto(f),a.isFunction(f.execute)&&f.execute()},this)},e.Context.prototype.mapCommands=function(){var b=this;a.each(this.commands,function(c,d){a.isArray(c)?a.each(c,function(a){b.mapCommand(d,a)}):b.mapCommand(d,c)})},e.Context.prototype.unmapAll=function(){this.vent.stopListening(),this.injector.unmapAll(),delete f[this._contextId],this.dispatchToParent(e.EVENT_CONTEXT_SHUTDOWN)},e.Context.extend=b.View.extend;var g={contexts:f,countEvents:function(){var b=0;return a.each(f,function(c,d){f.hasOwnProperty(d)&&(b+=a.size(c.vent._events))}),b},countContexts:function(){var b=0;return a.each(f,function(a,c){f.hasOwnProperty(c)&&b++}),b}};return e.setDebug=function(a){return this.debug=a?g:void 0,this.debug},b.Geppetto=e,e});