!function(a){"function"==typeof define&&define.amd?define(["underscore","backbone"],a):a(_,Backbone)}(function(a,b){"use strict";if(!b)throw"Please include Backbone before Geppetto";var c={};c.EVENT_CONTEXT_SHUTDOWN="Geppetto:contextShutdown";var d={};c.Context=function(c){this.options=c||{},this.parentContext=this.options.parentContext,this.vent={},a.extend(this.vent,b.Events),a.isFunction(this.initialize)&&this.initialize.apply(this,arguments),this._contextId=a.uniqueId("Context"),d[this._contextId]=this,this.mapCommands()},c.bindContext=function(b){this.options=b||{};var c=this.options.view,d=null;return"function"==typeof this.options.context?(d=new this.options.context(this.options),c.close||(c.close=function(){c.trigger("close"),c.remove()}),c.on("close",function(){c.off("close"),d.unmapAll()})):"object"==typeof this.options.context&&(d=this.options.context),c.context=d,a.each(c.contextEvents,function(b,e){a.isFunction(b)?d.listen(c,e,b):a.isString(b)&&d.listen(c,e,c[b])}),d},c.Context.prototype.listen=function(b,c,d){if(3!==arguments.length)throw"Expected 3 arguments (target, eventName, callback)";if(!a.isObject(b)||!a.isFunction(b.listenTo)||!a.isFunction(b.stopListening))throw"Target for listen() must define a 'listenTo' and 'stopListening' function";if(!a.isString(c))throw"eventName must be a String";if(!a.isFunction(d))throw"callback must be a function";return b.listenTo(this.vent,c,d,b)},c.Context.prototype.dispatch=function(b,c){if(!a.isUndefined(c)&&!a.isObject(c))throw"Event payload must be an object";c=c||{},c.eventName=b,this.vent.trigger(b,c)},c.Context.prototype.dispatchToParent=function(a,b){this.parentContext&&this.parentContext.vent.trigger(a,b)},c.Context.prototype.dispatchGlobally=function(b,c){a.each(d,function(a){a.vent.trigger(b,c)})},c.Context.prototype.mapCommand=function(b,c){var d=this;if(!a.isFunction(c))throw"Command must be constructable";this.vent.listenTo(this.vent,b,function(e){var f=new c;f.context=d,f.eventName=b,f.eventData=e,a.isFunction(f.execute)&&f.execute()},this)},c.Context.prototype.mapCommands=function(){var b=this;a.each(this.commands,function(c,d){a.isArray(c)?a.each(c,function(a){b.mapCommand(d,a)}):b.mapCommand(d,c)})},c.Context.prototype.unmapAll=function(){this.vent.stopListening(),delete d[this._contextId],this.dispatchToParent(c.EVENT_CONTEXT_SHUTDOWN)},c.Context.extend=b.View.extend;var e={contexts:d,countEvents:function(){var b=0;return a.each(d,function(c,e){d.hasOwnProperty(e)&&(b+=a.size(c.vent._events))}),b},countContexts:function(){var b=0;return a.each(d,function(a,c){d.hasOwnProperty(c)&&b++}),b}};return c.setDebug=function(a){return this.debug=a?e:void 0,this.debug},b.Geppetto=c,c});