!function(a){"function"==typeof define&&define.amd?define(["underscore","backbone"],a):a(_,Backbone)}(function(a,b){"use strict";if(!b)throw"Please include Backbone before Geppetto";var c="no mapping found for key: ",d={SINGLETON:"singleton",VIEW:"view",OTHER:"other"},e=function(a){this._mappings={},this._context=a,this.parent=void 0};e.prototype={_createAndSetupInstance:function(a,b){var c=new b;return this.injectInto(c,a),c},_retrieveFromCacheOrCreate:function(a,b){var e;if(this._mappings.hasOwnProperty(a)){var f=this._mappings[a];b||f.type!==d.SINGLETON?f.type===d.VIEW?e=f.clazz:f.clazz&&(e=this._createAndSetupInstance(a,f.clazz)):(f.object||(f.object=this._createAndSetupInstance(a,f.clazz)),e=f.object)}else{if(!this.parent||!this.parent.hasMapping(a))throw new Error(c+a);e=this.parent._retrieveFromCacheOrCreate(a,b)}return e},_wrapViewConstructor:function(a){var b=this._context,c=a.extend({initialize:function(){b.injector.injectInto(this),a.prototype.initialize.call(this,arguments)}});return c},createChildInjector:function(){var a=new e(this._context);return a.parent=this,a},getObject:function(a){return this._retrieveFromCacheOrCreate(a,!1)},mapValue:function(a,b){return this._mappings[a]={clazz:null,object:b,type:d.SINGLETON},this},hasMapping:function(a){return this._mappings.hasOwnProperty(a)||!!this.parent&&this.parent.hasMapping(a)},mapClass:function(a,b){return this._mappings[a]={clazz:b,object:null,type:d.OTHER},this},mapView:function(a,b){return this._mappings[a]={clazz:this._wrapViewConstructor(b),object:null,type:d.VIEW},this},mapSingleton:function(a,b){return this._mappings[a]={clazz:b,object:null,type:d.SINGLETON},this},instantiate:function(a){return this._retrieveFromCacheOrCreate(a,!0)},injectInto:function(b){return"object"==typeof b&&"injections"in b&&a.each(b.injections,function(a){b[a]=this.getObject(a)},this),this.addPubSub(b),this},addPubSub:function(b){b.listen=a.bind(this._context.listen,this._context),b.dispatch=a.bind(this._context.dispatch,this._context)},unmap:function(a){return delete this._mappings[a],this},unmapAll:function(){return this._mappings={},this}};var f={};f.version="0.6.3",f.EVENT_CONTEXT_SHUTDOWN="Geppetto:contextShutdown",f.Injector=e;var g={};f.Context=function(c){this.options=c||{},this.parentContext=this.options.parentContext,this.injector=this.parentContext?this.parentContext.injector.createChildInjector():new e(this),this.vent={},a.extend(this.vent,b.Events),a.isFunction(this.initialize)&&this.initialize.apply(this,arguments),this._contextId=a.uniqueId("Context"),g[this._contextId]=this,this.mapCommands()},f.bindContext=function(b){this.options=b||{};var c=this.options.view,d=null;return"function"==typeof this.options.context?(d=new this.options.context(this.options),c.close||(c.close=function(){c.trigger("close"),c.remove()}),c.on("close",function(){c.off("close"),d.unmapAll()})):"object"==typeof this.options.context&&(d=this.options.context),c.context=d,d.injector.injectInto(c),a.each(c.contextEvents,function(b,e){a.isFunction(b)?d.listen(c,e,b):a.isString(b)&&d.listen(c,e,c[b])}),d},f.Context.prototype.listen=function(b,c,d){if(3!==arguments.length)throw"Expected 3 arguments (target, eventName, callback)";if(!a.isObject(b)||!a.isFunction(b.listenTo)||!a.isFunction(b.stopListening))throw"Target for listen() must define a 'listenTo' and 'stopListening' function";if(!a.isString(c))throw"eventName must be a String";if(!a.isFunction(d))throw"callback must be a function";return b.listenTo(this.vent,c,d,b)},f.Context.prototype.dispatch=function(b,c){if(!a.isUndefined(c)&&!a.isObject(c))throw"Event payload must be an object";c=c||{},c.eventName=b,this.vent.trigger(b,c)},f.Context.prototype.dispatchToParent=function(a,b){this.parentContext&&this.parentContext.vent.trigger(a,b)},f.Context.prototype.dispatchGlobally=function(b,c){a.each(g,function(a){a.vent.trigger(b,c)})},f.Context.prototype.mapCommand=function(b,c){var d=this;if(!a.isFunction(c))throw"Command must be constructable";this.vent.listenTo(this.vent,b,function(e){var f=new c;f.context=d,f.eventName=b,f.eventData=e,d.injector.injectInto(f),a.isFunction(f.execute)&&f.execute()},this)},f.Context.prototype.mapCommands=function(){var b=this;a.each(this.commands,function(c,d){a.isArray(c)?a.each(c,function(a){b.mapCommand(d,a)}):b.mapCommand(d,c)})},f.Context.prototype.unmapAll=function(){this.vent.stopListening(),this.injector.unmapAll(),delete g[this._contextId],this.dispatchToParent(f.EVENT_CONTEXT_SHUTDOWN)},f.Context.extend=b.View.extend;var h={contexts:g,countEvents:function(){var b=0;return a.each(g,function(c,d){g.hasOwnProperty(d)&&(b+=a.size(c.vent._events))}),b},countContexts:function(){var b=0;return a.each(g,function(a,c){g.hasOwnProperty(c)&&b++}),b}};return f.setDebug=function(a){return this.debug=a?h:void 0,this.debug},b.Geppetto=f,f});